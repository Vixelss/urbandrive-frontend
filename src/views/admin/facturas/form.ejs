<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title><%= titulo %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>
  <%- include('../../partials/adminHeader') %>

  <main class="admin-page">
    <section class="admin-header-row">
      <div>
        <h1 class="admin-title"><%= titulo %></h1>
        <p class="admin-subtitle">
          Completa los datos de la factura. Todos los campos son obligatorios.
        </p>
      </div>
    </section>

    <%
      const f = factura || {};
      const esEdicion    = !!(f.IdFactura || f.idFactura);
      const idFactura    = f.IdFactura || f.idFactura || '';
      const idReservaSel = f.IdReserva || f.idReserva || '';
      const valorTotal   = f.ValorTotal || f.valorTotal || '';
      const uriFactura   = f.UriFactura || f.uriFactura || '';
    %>

    <section class="admin-card admin-card-form">
      <% if (errores && errores.length) { %>
        <div class="admin-alert admin-alert-error">
          <ul>
            <% errores.forEach(e => { %>
              <li><%= e %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>

      <form
        class="admin-form"
        method="post"
        action="<%= esEdicion ? ('/admin/facturas/' + idFactura + '/editar') : '/admin/facturas/nueva' %>">

        <div class="admin-form-grid">
          <!-- Reserva -->
          <div class="admin-field">
            <label for="idReserva">Reserva</label>
            <select id="idReserva" name="idReserva" required>
              <option value="">Selecciona una reserva</option>
              <% (reservas || []).forEach(r => {
                   const idR = r.IdReserva || r.idReserva;
                   const nombreUsu = r.NombreUsuario || r.nombreUsuario || '';
                   const vehiculo  = r.VehiculoNombre || r.vehiculoNombre || '';
                   const fechaIni  = (r.FechaInicio || r.fechaInicio || '').toString().slice(0,10);
                   const label = `#${idR} - ${nombreUsu} - ${vehiculo} (${fechaIni})`;
              %>
                <option value="<%= idR %>" <%= String(idR) === String(idReservaSel) ? 'selected' : '' %>>
                  <%= label %>
                </option>
              <% }) %>
            </select>
          </div>

          <!-- Enlace factura -->
          <div class="admin-field">
            <label for="uriFactura">Enlace factura (URL)</label>
            <input
              id="uriFactura"
              name="uriFactura"
              type="url"
              required
              placeholder="https://..."
              value="<%= uriFactura %>">
          </div>

          <!-- Valor total -->
          <div class="admin-field">
            <label for="valorTotal">Valor total</label>
            <input
              id="valorTotal"
              name="valorTotal"
              type="number"
              step="0.01"
              min="0"
              inputmode="decimal"
              pattern="^\\d+(\\.\\d{1,2})?$"
              title="Solo números positivos, con hasta 2 decimales."
              required
              value="<%= valorTotal %>">
          </div>
        </div>

        <div class="admin-form-actions">
          <a href="/admin/facturas" class="admin-btn admin-btn-secondary">Volver</a>
          <button type="submit" class="admin-primary-btn">
            <%= esEdicion ? 'Guardar cambios' : 'Crear factura' %>
          </button>
        </div>
      </form>
    </section>
  </main>

  <script>
    (function () {
      const valorInput = document.getElementById('valorTotal');
      if (valorInput) {
        valorInput.addEventListener('input', function () {
          // Quita cualquier cosa que no sea número, punto o coma
          this.value = this.value.replace(/[^0-9.,]/g, '');
        });
      }
    })();
  </script>
</body>
</html>
