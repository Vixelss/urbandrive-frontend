<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title><%= titulo %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>
  <%- include('../../partials/adminHeader') %>

  <main class="admin-page">
    <section class="admin-header-row">
      <div>
        <h1 class="admin-title"><%= titulo %></h1>
        <p class="admin-subtitle">
          Completa los datos de la reserva. Todos los campos son obligatorios.
        </p>
      </div>
    </section>

    <%
      const r = reserva || {};
      const esEdicion     = !!(r.IdReserva || r.idReserva);
      const idReserva     = r.IdReserva || r.idReserva || '';
      const idUsuarioSel  = r.IdUsuario || r.idUsuario || '';
      const idVehiculoSel = r.IdVehiculo || r.idVehiculo || '';

      let estadoSel = (r.Estado || r.estado || 'Pendiente').toString().trim();
      if (!estadoSel) estadoSel = 'Pendiente';

      const fechaIni = (r.FechaInicio || r.fechaInicio || '').toString().slice(0, 10);
      const fechaFin = (r.FechaFin   || r.fechaFin   || '').toString().slice(0, 10);
    %>

    <section class="admin-card admin-card-form">
      <% if (errores && errores.length) { %>
        <div class="admin-alert admin-alert-error">
          <ul>
            <% errores.forEach(e => { %>
              <li><%= e %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>

      <form
        class="admin-form"
        method="post"
        action="<%= esEdicion ? ('/admin/reservas/' + idReserva + '/editar') : '/admin/reservas/nueva' %>">

        <div class="admin-form-grid">
          <!-- Usuario -->
          <div class="admin-field">
            <label for="idUsuario">Usuario</label>
            <select id="idUsuario" name="idUsuario" required>
              <option value="">Selecciona un usuario</option>
              <% (usuarios || []).forEach(u => {
                   const idU = u.IdUsuario || u.idUsuario;
                   const nombre = (u.Nombre || '') + ' ' + (u.Apellido || '');
                   const correo = u.Email || u.email || '';
                   const label  = nombre + (correo ? ' – ' + correo : '');
              %>
                <option value="<%= idU %>" <%= String(idU) === String(idUsuarioSel) ? 'selected' : '' %>>
                  <%= label %>
                </option>
              <% }) %>
            </select>
          </div>

          <!-- Vehículo -->
          <div class="admin-field">
            <label for="idVehiculo">Vehículo</label>
            <select id="idVehiculo" name="idVehiculo" required>
              <option value="">Selecciona un vehículo</option>
              <% (vehiculos || []).forEach(v => {
                   const idV = v.IdVehiculo || v.idVehiculo;
                   const marca = v.Marca || v.marca || '';
                   const modelo = v.Modelo || v.modelo || '';
                   const matricula = v.Matricula || v.matricula || '';
                   const label = (marca + ' ' + modelo).trim() + (matricula ? ' – ' + matricula : '');
              %>
                <option value="<%= idV %>" <%= String(idV) === String(idVehiculoSel) ? 'selected' : '' %>>
                  <%= label %>
                </option>
              <% }) %>
            </select>
          </div>

          <!-- Fecha inicio -->
          <div class="admin-field">
            <label for="fechaInicio">Fecha inicio</label>
            <input
              type="date"
              id="fechaInicio"
              name="fechaInicio"
              value="<%= fechaIni %>"
              required>
          </div>

          <!-- Fecha fin -->
          <div class="admin-field">
            <label for="fechaFin">Fecha fin</label>
            <input
              type="date"
              id="fechaFin"
              name="fechaFin"
              value="<%= fechaFin %>"
              required>
          </div>

          <!-- Total -->
          <div class="admin-field">
            <label for="total">Total</label>
            <input
              id="total"
              name="total"
              type="number"
              step="0.01"
              min="0"
              inputmode="decimal"
              pattern="^\\d+(\\.\\d{1,2})?$"
              title="Solo números positivos, con hasta 2 decimales."
              required
              value="<%= r.Total || r.total || '' %>">
          </div>

          <!-- Estado -->
          <div class="admin-field">
            <label for="estado">Estado</label>
            <select id="estado" name="estado" required>
              <option value="Pendiente"  <%= estadoSel === 'Pendiente'  ? 'selected' : '' %>>Pendiente</option>
              <option value="Confirmada" <%= estadoSel === 'Confirmada' ? 'selected' : '' %>>Confirmada</option>
              <option value="Cancelada"  <%= estadoSel === 'Cancelada'  ? 'selected' : '' %>>Cancelada</option>
            </select>
          </div>
        </div>

        <div class="admin-form-actions">
          <a href="/admin/reservas" class="admin-btn admin-btn-secondary">Volver</a>
          <button type="submit" class="admin-primary-btn">
            <%= esEdicion ? 'Guardar cambios' : 'Crear reserva' %>
          </button>
        </div>
      </form>
    </section>
  </main>

  <script>
    (function () {
      const inputInicio = document.getElementById('fechaInicio');
      const inputFin    = document.getElementById('fechaFin');

      if (!inputInicio || !inputFin) return;

      // Hoy (solo fecha)
      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
      const hoyStr = hoy.toISOString().slice(0, 10); // YYYY-MM-DD

      // No permitir que el usuario elija una fecha de inicio antes de hoy
      inputInicio.min = hoyStr;

      function recalcularMinFin() {
        if (!inputInicio.value) return;

        const fIni = new Date(inputInicio.value + 'T00:00:00');
        fIni.setHours(0, 0, 0, 0);

        // mínimo fin = inicio + 1 día
        const fMinFin = new Date(fIni.getTime());
        fMinFin.setDate(fMinFin.getDate() + 1);

        const minFinStr = fMinFin.toISOString().slice(0, 10);
        inputFin.min = minFinStr;

        // Si la fecha fin actual es menor al mínimo, la ajustamos
        if (inputFin.value && inputFin.value < minFinStr) {
          inputFin.value = minFinStr;
        }
      }

      inputInicio.addEventListener('change', function () {
        if (inputInicio.value && inputInicio.value < hoyStr) {
          alert('La fecha de inicio no puede ser anterior a hoy.');
          inputInicio.value = hoyStr;
        }
        recalcularMinFin();
      });

      inputFin.addEventListener('change', function () {
        if (!inputFin.value || !inputInicio.value) return;
        const minFinStr = inputFin.min;
        if (minFinStr && inputFin.value < minFinStr) {
          alert('La fecha de fin debe ser al menos un día después de la fecha de inicio.');
          inputFin.value = minFinStr;
        }
      });

      // Al cargar la página solo calculamos el mínimo de fin (sin alerts)
      recalcularMinFin();
    })();
  </script>

  <script>
    (function () {
      const totalInput = document.getElementById('total');
      if (totalInput) {
        totalInput.addEventListener('input', function () {
          // Solo números y punto/coma
          this.value = this.value.replace(/[^0-9.,]/g, '');
        });
      }
    })();
  </script>
</body>
</html>
